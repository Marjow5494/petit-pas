<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Petit Pas</title>
    <style>
        :root {
            --bg-color: #fdfaf0; --primary-green: #78c0a8; --accent-pink: #f0a0b0;
            --text-color: #5d574f; --rest-blue: #a8dadc; --gold: #ffb800; --card-bg: #ffffff;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; padding: 0 20px 20px; margin: 0; min-height: 100vh; }
        header { width: 100%; padding: 15px 0; display: flex; align-items: center; justify-content: center; gap: 12px; }
        header img { width: 35px; height: 35px; }
        header h1 { font-size: 1.3rem; margin: 0; color: var(--primary-green); letter-spacing: 2px; font-weight: 800; }

        #bonsai-card { background: var(--card-bg); border-radius: 40px; padding: 25px; box-shadow: 0 10px 0px #eaddca; margin-bottom: 20px; text-align: center; width: 90%; max-width: 350px; border: 4px solid #f0e6d2; }
        #bonsai-viewer { width: 140px; height: 140px; margin: 0 auto; background-image: url('./bonsai.png'); background-size: 400% 200%; background-repeat: no-repeat; border-radius: 20px; transition: background-position 0.5s ease; background-color: #f9f9f9; }
        
        .points-display { font-size: 1.6rem; font-weight: bold; color: var(--primary-green); background: #f0f9f6; padding: 5px 25px; border-radius: 30px; display: inline-block; margin-top: 10px; }
        
        .menu-nav { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .menu-nav button { background: white; border: 2px solid #eee; padding: 10px 14px; border-radius: 18px; font-weight: bold; cursor: pointer; color: var(--text-color); font-size: 0.85rem; }

        .section { display: none; background: var(--card-bg); padding: 25px; border-radius: 35px; width: 90%; max-width: 350px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); box-sizing: border-box; }
        .active { display: block; }
        .category-title { margin: 20px 0 10px 0; color: var(--primary-green); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; font-weight: bold; }

        .task-container { background: #fff; border: 3px solid #f0f0f0; border-radius: 22px; margin-bottom: 12px; padding: 14px; position: relative; }
        .task-done { border-color: var(--primary-green); background-color: #fafffa; }
        .progress-wrapper { background: #eee; height: 10px; border-radius: 10px; margin: 8px 0; overflow: hidden; }
        .progress-fill { background: var(--primary-green); height: 100%; width: 0%; transition: width 0.4s; }
        .streak-fill { background: var(--gold) !important; }

        .btn-tap { background: var(--primary-green); color: white; border: none; padding: 12px; border-radius: 15px; font-weight: bold; width: 100%; cursor: pointer; box-shadow: 0 4px 0px #5e9c88; }
        .btn-undo { background: var(--accent-pink); color: white; border: none; padding: 8px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 5px; font-size: 0.8rem; box-shadow: 0 3px 0px #d48a98; }

        .admin-group { background: #f9f9f9; padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #eee; }
        input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 14px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 10px; margin-bottom: 5px; border: 1px solid #eee; font-size: 0.8rem; }
        .delete-btn { background: #ffeded; color: #ff5c5c; border: none; padding: 5px 8px; border-radius: 8px; font-size: 0.7rem; margin-left: 5px; cursor: pointer;}
        .edit-btn { background: #eef2ff; color: #4f46e5; border: none; padding: 5px 8px; border-radius: 8px; font-size: 0.7rem; cursor: pointer;}
        .item-link { color: #4a90e2; font-weight: bold; text-decoration: none; }
    </style>
</head>
<body>

    <header>
        <img src="https://cdn-icons-png.flaticon.com/512/628/628283.png" alt="Logo">
        <h1>PETIT PAS</h1>
    </header>

    <div id="bonsai-card">
        <div id="bonsai-viewer"></div>
        <div id="growth-stage" style="margin-top:10px; font-weight:bold; color:#aaa; font-size:0.8rem;">Graine</div>
        <div class="points-display"><span id="total-points">0</span></div>
    </div>

    <div class="menu-nav">
        <button onclick="showSection('tasks')">üçÉ Qu√™tes</button>
        <button onclick="showSection('shop')">üéÅ √âchoppe</button>
        <button onclick="showSection('admin')">‚öôÔ∏è</button>
    </div>

    <div id="tasks" class="section active">
        <div class="category-title">üìå Quotidiennes</div><div id="area-normal"></div>
        <div class="category-title">üî• S√©ries Hebdo</div><div id="area-streak"></div>
        <div class="category-title">üåü Bonus</div><div id="area-bonus"></div>
    </div>

    <div id="shop" class="section">
        <div class="admin-group">
            <h3 id="shop-form-title">Nouveau Souhait</h3>
            <input type="text" id="wish-name" placeholder="Nom de l'objet">
            <input type="number" id="wish-price" placeholder="Prix ($)">
            <input type="url" id="wish-url" placeholder="Lien URL (optionnel)">
            <button class="btn-tap" id="btn-add-wish" style="background:var(--accent-pink); box-shadow:0 4px 0px #d48a98" onclick="addWishItem()">Ajouter</button>
        </div>
        <div id="wish-list-area"></div>
    </div>

    <div id="admin" class="section">
        <div class="admin-group">
            <h3 id="task-form-title">Nouvelle Qu√™te</h3>
            <input type="text" id="task-name" placeholder="Nom">
            <input type="number" id="task-points" placeholder="Points">
            <select id="task-type" onchange="document.getElementById('target-box').style.display = (this.value==='streak'?'block':'none')">
                <option value="normal">Quotidienne</option>
                <option value="streak">S√©rie Hebdo</option>
                <option value="bonus">Bonus</option>
            </select>
            <div id="target-box" style="display:none"><input type="number" id="task-target" placeholder="Objectif" value="3"></div>
            <button class="btn-tap" id="btn-add-task" onclick="addNewTask()">Enregistrer</button>
        </div>
        <div class="admin-group">
            <h3>G√©rer les qu√™tes</h3>
            <div id="manage-tasks-list"></div>
        </div>
        <button onclick="resetAll()" style="color:#ccc; border:none; background:none; width:100%; font-size:10px; cursor: pointer;">EFFACER TOUT</button>
    </div>

    <script>
        let state = { points: 0, tasks: [], wishlist: [], lastLogin: "", lastWeek: 0 };
        let editingTaskIdx = null;
        let editingWishIdx = null;

        function loadData() {
            const saved = localStorage.getItem('bonsaiData');
            if (saved) state = Object.assign(state, JSON.parse(saved));
            checkTimeframes();
            handleUrlParams();
            updateUI();
        }

        function checkTimeframes() {
            const now = new Date();
            const today = now.toLocaleDateString();
            const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            const weekNo = Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(),0,1)))/86400000)+1)/7);

            if (state.lastLogin !== today) {
                state.tasks.forEach(t => { t.done = false; t.todayDone = false; });
                state.lastLogin = today;
            }
            if (state.lastWeek !== 0 && state.lastWeek !== weekNo) {
                state.tasks.forEach(t => { if(t.type === 'streak') t.streakCount = 0; });
            }
            state.lastWeek = weekNo;
            saveData();
        }

        function handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const taskName = urlParams.get('task');
            if (taskName) {
                const idx = state.tasks.findIndex(t => t.name.toLowerCase() === taskName.toLowerCase());
                if (idx !== -1) { progressTask(idx); window.history.replaceState({}, document.title, window.location.pathname); }
            }
        }

        function progressTask(index) {
            const t = state.tasks[index];
            if (t.type === 'streak') {
                if (t.todayDone) return;
                t.streakCount++; t.todayDone = true;
                if (t.streakCount >= t.target) { state.points += t.pts; t.streakCount = 0; }
            } else {
                if (t.done) return;
                state.points += t.pts; t.done = true;
            }
            saveData(); updateUI();
        }

        function undoTask(index) {
            const t = state.tasks[index];
            if (t.type === 'streak') { t.streakCount--; t.todayDone = false; }
            else { state.points -= t.pts; t.done = false; }
            saveData(); updateUI();
        }

        // --- GESTION DES TACHES ---
        function addNewTask() {
            const name = document.getElementById('task-name').value.trim();
            const pts = parseInt(document.getElementById('task-points').value);
            const type = document.getElementById('task-type').value;
            const target = parseInt(document.getElementById('task-target').value) || 1;

            if (!name || isNaN(pts)) return;

            if (editingTaskIdx !== null) {
                state.tasks[editingTaskIdx] = { ...state.tasks[editingTaskIdx], name, pts, type, target };
                editingTaskIdx = null;
                document.getElementById('task-form-title').innerText = "Nouvelle Qu√™te";
                document.getElementById('btn-add-task').innerText = "Enregistrer";
            } else {
                if (state.tasks.some(t => t.name.toLowerCase() === name.toLowerCase())) { alert("D√©j√† existant !"); return; }
                state.tasks.push({ name, pts, type, target, done: false, streakCount: 0, todayDone: false });
            }
            saveData(); updateUI();
            clearTaskForm();
        }

        function editTask(idx) {
            editingTaskIdx = idx;
            const t = state.tasks[idx];
            document.getElementById('task-name').value = t.name;
            document.getElementById('task-points').value = t.pts;
            document.getElementById('task-type').value = t.type;
            document.getElementById('task-target').value = t.target || 3;
            document.getElementById('target-box').style.display = (t.type === 'streak' ? 'block' : 'none');
            document.getElementById('task-form-title').innerText = "Modifier Qu√™te";
            document.getElementById('btn-add-task').innerText = "Mettre √† jour";
            showSection('admin');
            window.scrollTo(0,0);
        }

        function clearTaskForm() {
            document.getElementById('task-name').value = "";
            document.getElementById('task-points').value = "";
        }

        // --- GESTION DE LA BOUTIQUE ---
        function addWishItem() {
            const name = document.getElementById('wish-name').value.trim();
            const price = parseFloat(document.getElementById('wish-price').value);
            const url = document.getElementById('wish-url').value.trim();
            
            if (!name || isNaN(price)) return;

            if (editingWishIdx !== null) {
                state.wishlist[editingWishIdx] = { name, price, url, ptsNeeded: price * 100 };
                editingWishIdx = null;
                document.getElementById('shop-form-title').innerText = "Nouveau Souhait";
                document.getElementById('btn-add-wish').innerText = "Ajouter";
            } else {
                if (state.wishlist.some(w => w.name.toLowerCase() === name.toLowerCase())) { alert("D√©j√† existant !"); return; }
                state.wishlist.push({ name, price, url, ptsNeeded: price * 100 });
            }
            state.wishlist.sort((a, b) => a.price - b.price);
            saveData(); updateUI();
            document.getElementById('wish-name').value = ""; document.getElementById('wish-price').value = ""; document.getElementById('wish-url').value = "";
        }

        function editWish(idx) {
            editingWishIdx = idx;
            const w = state.wishlist[idx];
            document.getElementById('wish-name').value = w.name;
            document.getElementById('wish-price').value = w.price;
            document.getElementById('wish-url').value = w.url;
            document.getElementById('shop-form-title').innerText = "Modifier Souhait";
            document.getElementById('btn-add-wish').innerText = "Mettre √† jour";
            window.scrollTo(0,0);
        }

        function buyItem(idx) {
            const item = state.wishlist[idx];
            if (state.points >= item.ptsNeeded) {
                state.points -= item.ptsNeeded;
                state.wishlist.splice(idx, 1);
                saveData(); updateUI();
                alert("F√©licitations !");
            }
        }

        function updateUI() {
            document.getElementById('total-points').innerText = Math.floor(state.points);
            const areas = { normal: document.getElementById('area-normal'), streak: document.getElementById('area-streak'), bonus: document.getElementById('area-bonus') };
            Object.values(areas).forEach(a => a.innerHTML = '');

            state.tasks.forEach((t, idx) => {
                const isFinished = (t.type === 'streak') ? t.todayDone : t.done;
                const percent = (t.type === 'streak') ? (t.streakCount / t.target * 100) : (t.done ? 100 : 0);
                areas[t.type].innerHTML += `
                    <div class="task-container ${isFinished ? 'task-done' : ''}">
                        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:0.85rem;">
                            <span>${t.name}</span><span>${t.type==='streak' ? t.streakCount+'/'+t.target : t.pts+' pts'}</span>
                        </div>
                        <div class="progress-wrapper"><div class="progress-fill ${t.type==='streak'?'streak-fill':''}" style="width:${percent}%"></div></div>
                        ${!isFinished ? `<button class="btn-tap" onclick="progressTask(${idx})">Scanner</button>` : `<button class="btn-undo" onclick="undoTask(${idx})">Annuler</button>`}
                    </div>`;
            });

            const wishArea = document.getElementById('wish-list-area');
            wishArea.innerHTML = state.wishlist.length ? '<div class="category-title">Tes envies</div>' : '';
            state.wishlist.forEach((item, idx) => {
                const canAfford = state.points >= item.ptsNeeded;
                wishArea.innerHTML += `
                    <div class="task-container" style="border-color:var(--accent-pink)">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <b>${item.url ? `<a href="${item.url}" target="_blank" class="item-link">${item.name} üîó</a>` : item.name}</b>
                            <button class="edit-btn" onclick="editWish(${idx})">‚úèÔ∏è</button>
                        </div>
                        <small>${item.ptsNeeded} pts (${item.price}$)</small>
                        <button class="btn-tap" style="background:${canAfford?'var(--accent-pink)':'#eee'}; margin-top:10px; box-shadow:0 4px 0px ${canAfford?'#d48a98':'#ccc'}" onclick="buyItem(${idx})" ${canAfford?'':'disabled'}>
                            ${canAfford ? 'D√âBLOQUER' : 'Manque ' + Math.ceil(item.ptsNeeded - state.points) + ' pts'}
                        </button>
                    </div>`;
            });

            const manage = document.getElementById('manage-tasks-list');
            manage.innerHTML = '';
            state.tasks.forEach((t, idx) => {
                manage.innerHTML += `
                    <div class="item-row">
                        <span>${t.name} (${t.pts}p)</span>
                        <div>
                            <button class="edit-btn" onclick="editTask(${idx})">‚úèÔ∏è</button>
                            <button class="delete-btn" onclick="if(confirm('Supprimer?')){state.tasks.splice(${idx},1); saveData(); updateUI();}">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
            updateBonsai();
        }

        function updateBonsai() {
            const p = state.points;
            let stage = p < 500 ? 0 : p < 1500 ? 1 : p < 3000 ? 2 : p < 6000 ? 3 : p < 10000 ? 4 : p < 15000 ? 5 : p < 25000 ? 6 : 7;
            document.getElementById('bonsai-viewer').style.backgroundPosition = `${(stage % 4 * 33.33).toFixed(2)}% ${(Math.floor(stage / 4) * 100)}%`;
            const names = ["Graine", "Germe", "Pousse", "Jeune Arbre", "Bonsa√Ø", "Bonsa√Ø Fleuri", "Arbre de Fortune", "Ma√Ætre"];
            document.getElementById('growth-stage').innerText = names[stage];
        }

        function showSection(id) { document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function saveData() { localStorage.setItem('bonsaiData', JSON.stringify(state)); }
        function resetAll() { if(confirm("Tout effacer ?")) { localStorage.clear(); location.reload(); } }
        loadData();
    </script>
</body>
</html>
